<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Game Show</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            user-select: none;
            touch-action: manipulation;
        }
    </style>
</head>

<body>
    <header>
        <div>Team 1: <span id="team1Points">0</span> Punkte</div>
        <div id="gameNumber">Spiel 0 von 0</div>
        <div>Team 2: <span id="team2Points">0</span> Punkte</div>
    </header>

    <!-- Landing Screen -->
    <div id="landingScreen" class="quiz-container">
        <h2 id="gameTitle">Loading...</h2>
    </div>

    <!-- Rules Screen -->
    <div id="rulesScreen" class="quiz-container" style="display: none;">
        <h3>Regeln:</h3>
        <ul id="rulesList"></ul>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="quiz-container" style="display: none;">
        <h2 id="questionNumber" class="quiz-question-number">Beispiel Frage</h2>
        <div id="quizQuestion" class="quiz-question"></div>
        <div id="quizAnswer" class="quiz-answer"></div>

        <!-- Guessing game form -->
        <form id="guessForm" class="guess-form" style="display: none;">
            <div class="guess-input">
                <label for="team1Guess">Tipp Team 1:</label>
                <input type="number" id="team1Guess" required>
            </div>
            <div class="guess-input">
                <label for="team2Guess">Tipp Team 2:</label>
                <input type="number" id="team2Guess" required>
            </div>
            <button type="submit" class="quiz-button" style="margin: 20px auto;">Tipp Abgeben</button>
        </form>

        <!-- Betting form for final-quiz -->
        <div id="bettingForm" style="display: none;">
            <input type="number" id="team1Bet" placeholder="Gesetzte Punkte Team 1" class="guess-input"
                style="margin: 10px auto; width: 300px; display: block;">
            <input type="number" id="team2Bet" placeholder="Gesetzte Punkte Team 2" class="guess-input"
                style="margin: 10px auto; width: 300px; display: block;">
            <button id="submitBetsButton" class="quiz-button" style="margin: 20px auto;">Antwort anzeigen</button>
        </div>

        <!-- Correct/Incorrect buttons for final-quiz -->
        <div id="correctButtons" style="display: none; margin-top: 20px;">
            <div style="margin: 20px 0;">
                <h3>Team 1:</h3>
                <button id="team1Correct" class="quiz-button" style="margin: 10px;">Richtig</button>
                <button id="team1Incorrect" class="quiz-button" style="margin: 10px;">Falsch</button>
            </div>
            <div style="margin: 20px 0;">
                <h3>Team 2:</h3>
                <button id="team2Correct" class="quiz-button" style="margin: 10px;">Richtig</button>
                <button id="team2Incorrect" class="quiz-button" style="margin: 10px;">Falsch</button>
            </div>
        </div>

        <!-- Quizjagd game elements -->
        <div id="quizjagdHeader"
            style="display: none; text-align: center; margin-bottom: 30px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
            <h3 id="quizjagdQuestionNumber" style="margin: 0 0 10px 0; font-size: 1.2em; color: #ffd700;">Frage 1 von 5
            </h3>
            <h2 id="quizjagdPointsDisplay" style="margin: 0 0 10px 0; font-size: 2em; display: none;">3 Punkte</h2>
            <h2 id="quizjagdHeaderText" style="margin: 0; font-size: 1.5em;">Team ist dran</h2>
        </div>

        <div id="quizjagdBetting" style="display: none; text-align: center;">
            <div style="margin: 20px 0;">
                <button id="quizjagdBet3" class="quiz-button" style="margin: 10px;">3 Punkte (Leicht)</button>
                <button id="quizjagdBet5" class="quiz-button" style="margin: 10px;">5 Punkte (Mittel)</button>
                <button id="quizjagdBet7" class="quiz-button" style="margin: 10px;">7 Punkte (Schwer)</button>
            </div>
        </div>

        <div id="quizjagdQuestion" style="display: none;">
            <h3 id="quizjagdDifficulty" style="color: #ffd700; margin-bottom: 20px;"></h3>
            <p id="quizjagdQuestionText" style="font-size: 1.5em; margin-bottom: 30px;"></p>
        </div>

        <div id="quizjagdAnswer" class="quiz-answer hidden">
            <p id="quizjagdAnswerText" style="font-size: 1.6em; font-weight: 600;"></p>
        </div>

        <div id="quizjagdCorrectButtons" style="display: none; margin-top: 20px;">
            <button id="quizjagdCorrectButton" class="quiz-button"
                style="margin: 10px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">✓ Richtig</button>
            <button id="quizjagdIncorrectButton" class="quiz-button"
                style="margin: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">✗ Falsch</button>
        </div>

        <button id="nextQuestionButton" class="quiz-button" style="display: none; margin: 20px auto;">Nächste
            Frage</button>
    </div>

    <!-- Award Points Container -->
    <div id="awardPointsContainer" style="display: none;">
        <h2>Punkte vergeben</h2>
        <button class="quiz-button" style="margin: 20px auto;">Team 1</button>
        <button class="quiz-button" style="margin: 20px auto;">Team 2</button>
    </div>

    <!-- Next Game Screen -->
    <div id="nextGameScreen" class="quiz-container" style="display: none;">
        <button id="nextGameButton" class="quiz-button next-game-button" style="margin: 20px auto;">Nächstes
            Spiel</button>
    </div>

    <!-- Load game modules -->
    <script src="/game-modules/base-game.js"></script>
    <script src="/game-modules/simple-quiz.js"></script>
    <script src="/game-modules/guessing-game.js"></script>
    <script src="/game-modules/final-quiz.js"></script>
    <script src="/game-modules/audio-guess.js"></script>
    <script src="/game-modules/image-game.js"></script>
    <script src="/game-modules/four-statements.js"></script>
    <script src="/game-modules/fact-or-fake.js"></script>
    <script src="/game-modules/quizjagd.js"></script>
    <script src="/game-modules/game-factory.js"></script>
    <script src="background-music-player.js"></script>

    <script>
        let currentGame = null;

        async function loadGame() {
            // Get game index from URL
            const urlParams = new URLSearchParams(window.location.search);
            const gameIndex = parseInt(urlParams.get('index') || '0');

            try {
                // Clean up previous game if exists
                if (currentGame && currentGame.cleanup) {
                    currentGame.cleanup();
                }

                // Reset game container visibility
                document.getElementById('landingScreen').style.display = 'block';
                document.getElementById('rulesScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'none';

                // Fetch game configuration
                const response = await fetch(`/api/game/${gameIndex}`);
                if (!response.ok) {
                    throw new Error('Game not found');
                }

                const gameData = await response.json();
                const { gameId, config, currentIndex, totalGames } = gameData;

                // Update page title
                document.getElementById('pageTitle').textContent = config.title || `Game ${currentIndex + 1}`;
                document.getElementById('gameTitle').textContent = config.title || `Game ${currentIndex + 1}`;

                // Update game number in header
                document.getElementById('gameNumber').textContent = `Spiel ${currentIndex + 1} von ${totalGames}`;

                // Setup rules based on game type
                setupRules(config);

                // Create game instance using factory
                currentGame = GameFactory.createGame(
                    config.type,
                    config,
                    gameId,
                    currentIndex,
                    totalGames
                );

                // Initialize the game
                currentGame.init();

                // Handle audio crossfading when loading new game
                const newGameHasAudio = currentGame.hasAudioContent();

                // Fade out any playing game audio from previous game
                const audioElements = document.querySelectorAll('audio');
                let hasGameAudioPlaying = false;

                audioElements.forEach(audio => {
                    // Skip background music player's audio elements
                    if (window.backgroundMusicPlayer &&
                        window.backgroundMusicPlayer.audioElements.includes(audio)) {
                        return;
                    }
                    if (!audio.paused && audio.duration > 0) {
                        hasGameAudioPlaying = true;
                    }
                });

                // Crossfade: fade out game audio and fade in background music (if new game has no audio)
                if (hasGameAudioPlaying) {
                    // Fade out game audio from previous game
                    audioElements.forEach(audio => {
                        if (window.backgroundMusicPlayer &&
                            window.backgroundMusicPlayer.audioElements.includes(audio)) {
                            return;
                        }
                        if (!audio.paused && audio.duration > 0) {
                            const startVolume = audio.volume || 1;
                            const steps = 20;
                            const duration = 2000; // Original fade: 2 seconds
                            const stepDuration = duration / steps;
                            let step = 0;

                            const interval = setInterval(() => {
                                step++;
                                const progress = step / steps;
                                audio.volume = Math.max(0, startVolume * (1 - progress));

                                if (step >= steps) {
                                    clearInterval(interval);
                                    audio.pause();
                                    audio.currentTime = 0;
                                }
                            }, stepDuration);
                        }
                    });

                    // Fade in background music if new game has no audio (delay by 2 seconds, then 4 second fade)
                    if (!newGameHasAudio && window.backgroundMusicPlayer && !window.backgroundMusicPlayer.isPlaying) {
                        setTimeout(() => {
                            window.backgroundMusicPlayer.fadeIn(4000);
                        }, 2000);
                    }
                } else if (!newGameHasAudio && window.backgroundMusicPlayer && !window.backgroundMusicPlayer.isPlaying) {
                    // No game audio was playing, fade in background music with delay
                    setTimeout(() => {
                        window.backgroundMusicPlayer.fadeIn(4000);
                    }, 2000);
                }

            } catch (error) {
                console.error('Failed to load game:', error);
                document.getElementById('gameTitle').textContent = 'Error loading game';
                document.getElementById('landingScreen').innerHTML = `
                    <h2>Error loading game</h2>
                    <p>${error.message}</p>
                    <p>Check console for details</p>
                `;
            }
        }

        // Make loadGame globally accessible for SPA navigation
        window.loadGame = loadGame;

        function setupRules(config) {
            const rulesList = document.getElementById('rulesList');
            rulesList.innerHTML = '';

            // Default rules based on game type
            const rules = getRulesForGameType(config.type, config);
            rules.forEach(rule => {
                const li = document.createElement('li');
                li.textContent = rule;
                rulesList.appendChild(li);
            });

            // Add total questions if applicable
            if (config.questions && config.questions.length > 0) {
                const li = document.createElement('li');
                li.innerHTML = `Es gibt insgesamt <span id="totalQuestions">${config.questions.length - 1}</span> Fragen.`;
                rulesList.appendChild(li);
            }
        }

        function getRulesForGameType(type, config) {
            // Return rules from config if available, otherwise fallback to default
            if (config.rules && config.rules.length > 0) {
                return config.rules;
            }

            // Fallback rules if not defined in config
            return ['Spiel-spezifische Regeln werden angezeigt.'];
        }

        // Load game on page load
        window.addEventListener('DOMContentLoaded', loadGame);

        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.gameIndex !== undefined) {
                loadGame();
            }
        });

        // Music is now controlled via the always-visible music controls

        // Setup music controls
        window.addEventListener('DOMContentLoaded', function () {
            const playPauseBtn = document.getElementById('musicPlayPause');
            const volumeSlider = document.getElementById('musicVolume');
            const nextBtn = document.getElementById('musicNext'); const musicToggle = document.getElementById('musicToggle');
            const musicControls = document.getElementById('musicControls');
            let controlsVisible = false;
            let lastMousePosition = { x: 0, y: 0 };
            let mouseMovedDistance = 0;

            // Show controls on hover
            if (musicToggle) {
                musicToggle.addEventListener('mouseenter', (e) => {
                    controlsVisible = true;
                    musicControls.classList.add('visible');
                    musicToggle.innerHTML = '▶';
                    lastMousePosition = { x: e.clientX, y: e.clientY };
                    mouseMovedDistance = 0;
                });
            }

            // Auto-hide controls when clicking outside
            document.addEventListener('click', (e) => {
                if (controlsVisible && !musicControls.contains(e.target)) {
                    controlsVisible = false;
                    musicControls.classList.remove('visible');
                    if (musicToggle) {
                        musicToggle.innerHTML = '◀';
                    }
                }
            });

            // Auto-hide controls when mouse moves 200px away
            document.addEventListener('mousemove', (e) => {
                if (!controlsVisible) return;

                // Check if mouse is over the controls or toggle
                const rect = musicControls.getBoundingClientRect();
                const toggleRect = musicToggle ? musicToggle.getBoundingClientRect() : null;
                const isOverControls = (
                    e.clientX >= rect.left &&
                    e.clientX <= rect.right &&
                    e.clientY >= rect.top &&
                    e.clientY <= rect.bottom
                );
                const isOverToggle = toggleRect && (
                    e.clientX >= toggleRect.left &&
                    e.clientX <= toggleRect.right &&
                    e.clientY >= toggleRect.top &&
                    e.clientY <= toggleRect.bottom
                );

                if (isOverControls || isOverToggle) {
                    // Reset tracking when over controls or toggle
                    lastMousePosition = { x: e.clientX, y: e.clientY };
                    mouseMovedDistance = 0;
                } else {
                    // Calculate distance moved
                    const deltaX = e.clientX - lastMousePosition.x;
                    const deltaY = e.clientY - lastMousePosition.y;
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    mouseMovedDistance += distance;
                    lastMousePosition = { x: e.clientX, y: e.clientY };

                    // Hide if moved more than 200px
                    if (mouseMovedDistance > 200) {
                        controlsVisible = false;
                        musicControls.classList.remove('visible');
                        if (musicToggle) {
                            musicToggle.innerHTML = '◀';
                        }
                        mouseMovedDistance = 0;
                    }
                }
            });

            // Make timeline clickable to seek
            const timeline = document.getElementById('musicTimeline');
            if (timeline) {
                timeline.addEventListener('click', (e) => {
                    if (window.backgroundMusicPlayer && window.backgroundMusicPlayer.isPlaying) {
                        const audio = window.backgroundMusicPlayer.audioElements[window.backgroundMusicPlayer.currentAudioIndex];
                        if (audio && audio.duration) {
                            const rect = timeline.getBoundingClientRect();
                            const clickX = e.clientX - rect.left;
                            const percentage = clickX / rect.width;
                            audio.currentTime = percentage * audio.duration;
                        }
                    }
                });
                timeline.style.cursor = 'pointer';
            }

            // Update timeline
            setInterval(() => {
                if (window.backgroundMusicPlayer && window.backgroundMusicPlayer.isPlaying) {
                    const audio = window.backgroundMusicPlayer.audioElements[window.backgroundMusicPlayer.currentAudioIndex];
                    if (audio && audio.duration) {
                        const progress = (audio.currentTime / audio.duration) * 100;
                        const progressBar = document.getElementById('timelineProgress');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                    }
                }
            }, 100);
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.backgroundMusicPlayer) {
                        if (window.backgroundMusicPlayer.isPlaying) {
                            window.backgroundMusicPlayer.pause();
                            playPauseBtn.textContent = '▶';
                        } else {
                            // Check if music was ever started
                            if (window.backgroundMusicPlayer.audioElements[window.backgroundMusicPlayer.currentAudioIndex].src) {
                                // Resume paused music
                                window.backgroundMusicPlayer.resume();
                            } else {
                                // Start music for the first time
                                window.backgroundMusicPlayer.start();
                            }
                            playPauseBtn.textContent = '⏸';
                        }
                    }
                });
            }

            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    if (window.backgroundMusicPlayer) {
                        const volume = e.target.value;
                        window.backgroundMusicPlayer.setVolume(volume / 100);
                        const volumeLabel = document.getElementById('volumeLabel');
                        if (volumeLabel) volumeLabel.textContent = volume + '%';
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.backgroundMusicPlayer) {
                        window.backgroundMusicPlayer.skipToNext();
                    }
                });
            }
        });
    </script>

    <!-- Background Music Controls -->
    <div class="music-controls" id="musicControls" onclick="event.stopPropagation();">
        <button class="music-toggle" id="musicToggle" onclick="event.stopPropagation();">
            ◀
        </button>
        <div class="music-controls-content">
            <div class="music-controls-row">
                <button id="musicPlayPause" title="Play/Pause">▶</button>
                <div class="volume-control">
                    <input type="range" id="musicVolume" min="0" max="100" value="10" title="Volume">
                    <span class="volume-label" id="volumeLabel">10%</span>
                </div>
                <button id="musicNext" title="Next Track">⏭</button>
            </div>
            <div class="music-timeline" id="musicTimeline">
                <div class="timeline-bar">
                    <div class="timeline-progress" id="timelineProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="imageLightbox"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; justify-content: center; align-items: center; cursor: pointer;">
        <img id="lightboxImage" src="" alt=""
            style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 15px; box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);">
    </div>

    <script>
        // Lightbox functionality
        const lightbox = document.getElementById('imageLightbox');
        const lightboxImage = document.getElementById('lightboxImage');

        lightbox.addEventListener('click', function (event) {
            event.stopPropagation();
            lightbox.style.display = 'none';
        });

        window.openImageLightbox = function (imageSrc) {
            lightboxImage.src = imageSrc;
            lightbox.style.display = 'flex';
        };
    </script>
</body>

</html>
