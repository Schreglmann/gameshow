<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Game Show</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            user-select: none;
            touch-action: manipulation;
        }
    </style>
</head>

<body>
    <header>
        <div>Team 1: <span id="team1Points">0</span> Punkte</div>
        <div id="gameNumber">Spiel 0 von 0</div>
        <div>Team 2: <span id="team2Points">0</span> Punkte</div>
    </header>

    <!-- Landing Screen -->
    <div id="landingScreen" class="quiz-container">
        <h2 id="gameTitle">Loading...</h2>
    </div>

    <!-- Rules Screen -->
    <div id="rulesScreen" class="quiz-container" style="display: none;">
        <h3>Regeln:</h3>
        <ul id="rulesList"></ul>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="quiz-container" style="display: none;">
        <h2 id="questionNumber" class="quiz-question-number">Beispiel Frage</h2>
        <div id="quizQuestion" class="quiz-question"></div>
        <div id="quizAnswer" class="quiz-answer"></div>

        <!-- Guessing game form -->
        <form id="guessForm" class="guess-form" style="display: none;">
            <div class="guess-input">
                <label for="team1Guess">Tipp Team 1:</label>
                <input type="number" id="team1Guess" required>
            </div>
            <div class="guess-input">
                <label for="team2Guess">Tipp Team 2:</label>
                <input type="number" id="team2Guess" required>
            </div>
            <button type="submit" class="quiz-button" style="margin: 20px auto;">Tipp Abgeben</button>
        </form>

        <!-- Betting form for final-quiz -->
        <div id="bettingForm" style="display: none;">
            <input type="number" id="team1Bet" placeholder="Gesetzte Punkte Team 1" class="guess-input"
                style="margin: 10px auto; width: 300px; display: block;">
            <input type="number" id="team2Bet" placeholder="Gesetzte Punkte Team 2" class="guess-input"
                style="margin: 10px auto; width: 300px; display: block;">
            <button id="submitBetsButton" class="quiz-button" style="margin: 20px auto;">Antwort anzeigen</button>
        </div>

        <!-- Correct/Incorrect buttons for final-quiz -->
        <div id="correctButtons" style="display: none; margin-top: 20px;">
            <div style="margin: 20px 0;">
                <h3>Team 1:</h3>
                <button id="team1Correct" class="quiz-button" style="margin: 10px;">Richtig</button>
                <button id="team1Incorrect" class="quiz-button" style="margin: 10px;">Falsch</button>
            </div>
            <div style="margin: 20px 0;">
                <h3>Team 2:</h3>
                <button id="team2Correct" class="quiz-button" style="margin: 10px;">Richtig</button>
                <button id="team2Incorrect" class="quiz-button" style="margin: 10px;">Falsch</button>
            </div>
        </div>

        <button id="nextQuestionButton" class="quiz-button" style="display: none; margin: 20px auto;">Nächste
            Frage</button>
    </div>

    <!-- Award Points Container -->
    <div id="awardPointsContainer" style="display: none;">
        <h2>Punkte vergeben</h2>
        <button class="quiz-button" style="margin: 20px auto;">Team 1</button>
        <button class="quiz-button" style="margin: 20px auto;">Team 2</button>
    </div>

    <!-- Next Game Screen -->
    <div id="nextGameScreen" class="quiz-container" style="display: none;">
        <button id="nextGameButton" class="quiz-button next-game-button" style="margin: 20px auto;">Nächstes
            Spiel</button>
    </div>

    <!-- Load game modules -->
    <script src="/game-modules/base-game.js"></script>
    <script src="/game-modules/simple-quiz.js"></script>
    <script src="/game-modules/guessing-game.js"></script>
    <script src="/game-modules/final-quiz.js"></script>
    <script src="/game-modules/audio-guess.js"></script>
    <script src="/game-modules/image-game.js"></script>
    <script src="/game-modules/four-statements.js"></script>
    <script src="/game-modules/fact-or-fake.js"></script>
    <script src="/game-modules/game-factory.js"></script>

    <script>
        let currentGame = null;

        async function loadGame() {
            // Get game index from URL
            const urlParams = new URLSearchParams(window.location.search);
            const gameIndex = parseInt(urlParams.get('index') || '0');

            try {
                // Fetch game configuration
                const response = await fetch(`/api/game/${gameIndex}`);
                if (!response.ok) {
                    throw new Error('Game not found');
                }

                const gameData = await response.json();
                const { gameId, config, currentIndex, totalGames } = gameData;

                // Update page title
                document.getElementById('pageTitle').textContent = config.title || `Game ${currentIndex + 1}`;
                document.getElementById('gameTitle').textContent = config.title || `Game ${currentIndex + 1}`;

                // Update game number in header
                document.getElementById('gameNumber').textContent = `Spiel ${currentIndex + 1} von ${totalGames}`;

                // Setup rules based on game type
                setupRules(config);

                // Create game instance using factory
                currentGame = GameFactory.createGame(
                    config.type,
                    config,
                    gameId,
                    currentIndex,
                    totalGames
                );

                // Initialize the game
                currentGame.init();

            } catch (error) {
                console.error('Failed to load game:', error);
                document.getElementById('gameTitle').textContent = 'Error loading game';
                document.getElementById('landingScreen').innerHTML = `
                    <h2>Error loading game</h2>
                    <p>${error.message}</p>
                    <p>Check console for details</p>
                `;
            }
        }

        function setupRules(config) {
            const rulesList = document.getElementById('rulesList');
            rulesList.innerHTML = '';

            // Default rules based on game type
            const rules = getRulesForGameType(config.type, config);
            rules.forEach(rule => {
                const li = document.createElement('li');
                li.textContent = rule;
                rulesList.appendChild(li);
            });

            // Add total questions if applicable
            if (config.questions && config.questions.length > 0) {
                const li = document.createElement('li');
                li.innerHTML = `Es gibt insgesamt <span id="totalQuestions">${config.questions.length - 1}</span> Fragen.`;
                rulesList.appendChild(li);
            }
        }

        function getRulesForGameType(type, config) {
            // Return rules from config if available, otherwise fallback to default
            if (config.rules && config.rules.length > 0) {
                return config.rules;
            }

            // Fallback rules if not defined in config
            return ['Spiel-spezifische Regeln werden angezeigt.'];
        }

        // Load game on page load
        window.addEventListener('DOMContentLoaded', loadGame);
    </script>
</body>

</html>
